# Задание 2. Архитектура решения

Схема контейнеров (ToBe):
    [Ссылка на схему](https://github.com/noisegrind3r/architecture-sprint-10/blob/sprint_10/Task2/medikamente_container_diagram_ToBe.png)

Описание контейнеров:
  Предлагается доработать систему "Медикаменке" следующим образом:
  1. Добавить портал пользователей, состоящий из контейнеров: Frontend (Vue3), Backend (NestJs), БД (Postgres).
  2. Добавить портал для специалистов компании, состоящий из контейнеров: Frontend (Vue3), Backend (NestJs), БД (Postgres).
  3. Добавить платежный сервис, состоящий из контейнеров: Backend (NestJs), БД (Postgres).
  4. Добавить сервис для работы с лабораторией, состоящий из контейнеров: Backend (NestJs), БД (Postgres).
  5. Добавить сервис для отправки уведомлений пользователям, состоящий из контейнера Backend (NestJs).
  5. Добавить API Gateway для портала пользователей и отдельно для портала сотрудников.
  6. Для реализации аутентификации и авторизации добавить сервис Keycloak.
  7. Для захвата данных добавить сервис Debezium и Hadoop для реализации системы Data Lake.
  8. Добавить брокер сообщений Kafka для асинхронных взаимодействий между сервисами.

Описание взаимодействия контейнеров.
  
  Портал пользователя:
  - Пользователь вводит учетные данные и входит в систему. Проверку учетных данных осуществляет сервис Keycloak. API Gateway проверяет каждый запрос пользователя с помощью приложенного JWT-токена и, в случае успешной проверки, добавляет в запрос информацию о правах. В дальнейшем, на стороне бэкенда в каждом запросе имеется контекст пользователя, по которому можно проверить доступные пользователю данные.
  - Когда пользователь подает заявку на прием, то информация о ней передается в портал специалистов компании, где подтверждается сотрудником ресепшена, с помощью брокера сообщений Kafka. Информация о подтверждении также возвращается через Kafka.
  - Пользователь может оплатить прием на сайте и информация о платеже передается в сервис оплаты, также с помощью брокера сообщений Kafka.
  - Персональные данные пользователя хранятся в БД в зашифрованном с помощью pgcrypto виде.
  - По всем данным в БД ведется аудит (кто создавал, изменял, удалял)

  Портал сотрудников:
  - Сотрудники ресепшена и медицинские специалисты взаимодействуют с порталом сотрудников, где их учетные данные аналогично проверяются с помощью сервиса Keycloak.
  - Для разделения прав пользователя используется модель RBAC, где сотрудники ресепшена могут только просматривать персональную информацию пользователей, а доктора могут просматривать медицинские данные только по своим пациентам. 
  - Для взаимодействия с лабораторией используется отдельный сервис, который отправляет и получает данные об анализах и авторизует каждый запрос согласно контексту пользователя
  - Медицинские данные пользователя хранятся в БД в зашифрованном с помощью pgcrypto виде.
  - По всем данным в БД ведется аудит (кто создавал, изменял, удалял)

  Сервис оплат:
  - При получении платежных данных через брокер сообщений Kafka, сервис проводит процесс оплаты на ККМ
  - После проведения оплаты, информация о ней отправляется в 1С
  - Финансовые данные хранятся в БД в зашифрованном с помощью pgcrypto виде.
  - По всем данным в БД ведется аудит (кто создавал, изменял, удалял)

  Data Lake
  - Все данные, для последующей аналитики и обработки, собираются с помощью сервиса Debezium, подключенного непосредственно к БД сервисов пользователя, сотрудников, оплаты и других
  - В процессе обработки Debezium обезличивает персональные, медицинские и финансовые данные


Комментарии:
 
  - как данные хранятся: вся чувствительная информация (персональные, медицинские и финансовые) хранится в зашифрованном виде в БД с помощью pgcrypto. Права доступа регулируются с помощью модели RBAC.
  - периоды и условия уничтожения конфиденциальных данных после обработки: персональные и медицинские данные хранятся 2 года после последнего обращения пациента, после чего переводятся в архивные, досутп к которым может получить только пользователей после обращений. Ещё через 2 года не активности данные удаляются без возможности восстановления. Также, для соблюдения законодательства, данные могут быть удалены сразу по письменному запросу пациента.
  - какие способы защиты данных используются при хранении и передаче данных: Данные хранятся в зашифрованном виде AES-256 с помощью pgcrypto; передача данных между сервисами зашифрована с использованием протокола TLS1.2 или выше.